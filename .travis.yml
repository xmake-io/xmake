sudo: false
language: C

matrix:
  include:
    - os: osx
    - os: linux
      dist: trusty
      compiler: gcc-5
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - gcc-5
            - python3

env:
  global:
    - LUAROCKS=2.2.2
    - LUA=lua5.1

before_install:
  - rm install
  - source scripts/.travis/setenv_lua.sh
  - luarocks install luacov

install:
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then brew install dmd rust python3; fi

script:
  - scripts/get.sh __local__
  - xmake lua versioninfo
  - xmake f -m coverage -P core
  - xmake -P core
  - export XMAKE_PROGRAM_DIR=$PWD/xmake
  - core/build/xmake lua versioninfo
  - echo 'require("luacov")' > tmp
  - cat xmake/core/_xmake_main.lua >> tmp
  - mv tmp xmake/core/_xmake_main.lua
  - cp core/build/xmake $(which xmake) || sudo cp core/build/xmake $(which xmake)
  - sh -c 'cd tests; python3 test.py'

after_success:
  - mv tests/luacov.stats.out .
  - luacov
  - bash <(curl -s https://codecov.io/bash)
